<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Limit Dashboard - Portal Security</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.9em;
            color: #666;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .event-item:hover {
            background: #f9f9f9;
        }

        .event-item.blocked {
            background: #fee2e2;
        }

        .event-item.blocked:hover {
            background: #fecaca;
        }

        .event-time {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .event-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-endpoint {
            font-weight: 500;
            color: #333;
        }

        .event-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .event-status.allowed {
            background: #d1fae5;
            color: #065f46;
        }

        .event-status.blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        .offenders-list {
            list-style: none;
        }

        .offender-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .offender-info {
            flex: 1;
        }

        .offender-id {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .offender-ip {
            color: #666;
            font-size: 0.9em;
        }

        .offender-stats {
            text-align: right;
        }

        .offender-blocked {
            color: #ef4444;
            font-weight: bold;
            font-size: 1.2em;
        }

        .offender-total {
            color: #666;
            font-size: 0.9em;
        }

        .chart-container {
            margin-top: 20px;
            height: 300px;
            position: relative;
        }

        .endpoint-stats {
            margin-top: 30px;
        }

        .endpoint-grid {
            display: grid;
            gap: 15px;
        }

        .endpoint-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .endpoint-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .endpoint-method {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            background: #e0e7ff;
            color: #3730a3;
            margin-right: 8px;
        }

        .endpoint-metrics {
            display: flex;
            gap: 20px;
        }

        .endpoint-metric {
            text-align: center;
        }

        .endpoint-metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .endpoint-metric-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #10b981;
        }

        .status-indicator.warning {
            background: #f59e0b;
        }

        .status-indicator.critical {
            background: #ef4444;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 currentColor;
            }
            70% {
                box-shadow: 0 0 0 10px transparent;
            }
            100% {
                box-shadow: 0 0 0 0 transparent;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üõ°Ô∏è Rate Limit Dashboard</h1>
            <div class="subtitle">
                <span class="status-indicator active"></span>
                Real-time API rate limiting monitoring and management
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Requests</div>
                <div class="metric-value" id="total-requests">0</div>
                <div class="metric-change positive">‚Üë 0% from last hour</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Blocked Requests</div>
                <div class="metric-value" id="blocked-requests">0</div>
                <div class="metric-change" id="block-rate">0% block rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Clients</div>
                <div class="metric-value" id="active-clients">0</div>
                <div class="metric-change">0 new today</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Endpoints</div>
                <div class="metric-value" id="active-endpoints">0</div>
                <div class="metric-change">All systems operational</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üìä Real-time Events</h2>
                <div class="events-list" id="events-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Connecting to monitoring service...</div>
                    </div>
                </div>
                
                <div class="endpoint-stats">
                    <h3 style="margin-bottom: 15px; color: #333;">Top Endpoints</h3>
                    <div class="endpoint-grid" id="endpoint-grid">
                        <!-- Endpoints will be populated here -->
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>‚ö†Ô∏è Top Offenders</h2>
                <ul class="offenders-list" id="offenders-list">
                    <li class="offender-item">
                        <div class="loading">
                            <div>Loading client data...</div>
                        </div>
                    </li>
                </ul>

                <div class="controls">
                    <button class="btn btn-primary" onclick="exportData()">
                        üì• Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="resetStats()">
                        üîÑ Reset Stats
                    </button>
                    <button class="btn btn-secondary" onclick="refreshDashboard()">
                        ‚Üª Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time updates
        let ws = null;
        let reconnectTimeout = null;
        let eventHistory = [];
        let maxEvents = 50;

        // Initialize dashboard
        function initDashboard() {
            connectWebSocket();
            fetchMetrics();
            setInterval(fetchMetrics, 5000); // Update metrics every 5 seconds
        }

        // Connect to WebSocket for real-time events
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/rate-limits`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('Connected to rate limit monitoring');
                    updateConnectionStatus('active');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleRealtimeEvent(data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus('warning');
                };
                
                ws.onclose = () => {
                    console.log('WebSocket connection closed');
                    updateConnectionStatus('critical');
                    scheduleReconnect();
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                // Fallback to polling
                usePollingFallback();
            }
        }

        // Schedule WebSocket reconnection
        function scheduleReconnect() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
            reconnectTimeout = setTimeout(() => {
                console.log('Attempting to reconnect...');
                connectWebSocket();
            }, 5000);
        }

        // Fallback to polling if WebSocket fails
        function usePollingFallback() {
            setInterval(() => {
                fetch('/api/rate-limits/events?limit=10')
                    .then(res => res.json())
                    .then(events => {
                        events.forEach(handleRealtimeEvent);
                    })
                    .catch(console.error);
            }, 2000);
        }

        // Handle real-time event
        function handleRealtimeEvent(event) {
            // Add to history
            eventHistory.unshift(event);
            if (eventHistory.length > maxEvents) {
                eventHistory.pop();
            }
            
            // Update UI
            updateEventsList();
        }

        // Update events list UI
        function updateEventsList() {
            const container = document.getElementById('events-list');
            
            if (eventHistory.length === 0) {
                container.innerHTML = '<div class="loading">No events yet...</div>';
                return;
            }
            
            container.innerHTML = eventHistory.map(event => {
                const time = new Date(event.timestamp).toLocaleTimeString();
                const statusClass = event.blocked ? 'blocked' : 'allowed';
                const statusText = event.blocked ? 'BLOCKED' : 'ALLOWED';
                
                return `
                    <div class="event-item ${statusClass}">
                        <div class="event-time">${time}</div>
                        <div class="event-details">
                            <div>
                                <span class="event-endpoint">${event.method} ${event.endpoint}</span>
                                <div style="color: #666; font-size: 0.85em; margin-top: 4px;">
                                    Client: ${event.clientId} | IP: ${event.ip}
                                </div>
                            </div>
                            <div>
                                <span class="event-status ${statusClass}">${statusText}</span>
                                <div style="color: #666; font-size: 0.85em; margin-top: 4px;">
                                    ${event.remaining}/${event.limit} remaining
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Fetch and update metrics
        function fetchMetrics() {
            fetch('/api/rate-limits/metrics')
                .then(res => res.json())
                .then(data => {
                    updateMetrics(data);
                    updateTopOffenders(data.topOffenders);
                    updateTopEndpoints(data.topEndpoints);
                })
                .catch(error => {
                    console.error('Failed to fetch metrics:', error);
                });
        }

        // Update metrics display
        function updateMetrics(data) {
            document.getElementById('total-requests').textContent = 
                data.totalRequests.toLocaleString();
            document.getElementById('blocked-requests').textContent = 
                data.totalBlocked.toLocaleString();
            document.getElementById('active-clients').textContent = 
                data.uniqueClients.toLocaleString();
            document.getElementById('active-endpoints').textContent = 
                data.activeEndpoints.toLocaleString();
            
            const blockRateEl = document.getElementById('block-rate');
            const blockRate = data.blockRate.toFixed(1);
            blockRateEl.textContent = `${blockRate}% block rate`;
            blockRateEl.className = blockRate > 10 ? 'metric-change negative' : 'metric-change';
        }

        // Update top offenders list
        function updateTopOffenders(offenders) {
            const container = document.getElementById('offenders-list');
            
            if (!offenders || offenders.length === 0) {
                container.innerHTML = '<li class="offender-item">No offenders detected</li>';
                return;
            }
            
            container.innerHTML = offenders.map(offender => `
                <li class="offender-item">
                    <div class="offender-info">
                        <div class="offender-id">${offender.clientId}</div>
                        <div class="offender-ip">${offender.ip}</div>
                    </div>
                    <div class="offender-stats">
                        <div class="offender-blocked">${offender.totalBlocked}</div>
                        <div class="offender-total">of ${offender.totalRequests} blocked</div>
                    </div>
                </li>
            `).join('');
        }

        // Update top endpoints
        function updateTopEndpoints(endpoints) {
            const container = document.getElementById('endpoint-grid');
            
            if (!endpoints || endpoints.length === 0) {
                container.innerHTML = '<div>No endpoint data available</div>';
                return;
            }
            
            container.innerHTML = endpoints.map(endpoint => {
                const [method, path] = endpoint.endpoint.split(':');
                return `
                    <div class="endpoint-card">
                        <div>
                            <span class="endpoint-method">${method || 'GET'}</span>
                            <span class="endpoint-name">${path || endpoint.endpoint}</span>
                        </div>
                        <div class="endpoint-metrics">
                            <div class="endpoint-metric">
                                <div class="endpoint-metric-value">${endpoint.requests.toLocaleString()}</div>
                                <div class="endpoint-metric-label">requests</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const indicator = document.querySelector('.status-indicator');
            indicator.className = `status-indicator ${status}`;
        }

        // Export data
        function exportData() {
            fetch('/api/rate-limits/export')
                .then(res => res.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rate-limits-${new Date().toISOString()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Failed to export data:', error);
                    alert('Failed to export data. Please try again.');
                });
        }

        // Reset statistics
        function resetStats() {
            if (confirm('Are you sure you want to reset all statistics? This action cannot be undone.')) {
                fetch('/api/rate-limits/reset', { method: 'POST' })
                    .then(() => {
                        eventHistory = [];
                        updateEventsList();
                        fetchMetrics();
                        alert('Statistics have been reset successfully.');
                    })
                    .catch(error => {
                        console.error('Failed to reset stats:', error);
                        alert('Failed to reset statistics. Please try again.');
                    });
            }
        }

        // Refresh dashboard
        function refreshDashboard() {
            fetchMetrics();
            fetch('/api/rate-limits/events?limit=50')
                .then(res => res.json())
                .then(events => {
                    eventHistory = events;
                    updateEventsList();
                })
                .catch(console.error);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
        });
    </script>
</body>
</html>