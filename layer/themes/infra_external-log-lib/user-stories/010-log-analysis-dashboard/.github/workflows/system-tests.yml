name: System Tests - Embedded Web Applications

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run system tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  system-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        browser: [chromium, firefox, webkit]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Build application
      run: npm run build
      
    - name: Start log analysis dashboard in background
      run: |
        npm run dev &
        sleep 10
        
    - name: Run system tests
      run: npm run test:system:playwright
      env:
        CI: true
        PLAYWRIGHT_BROWSER: ${{ matrix.browser }}
        
    - name: Run comprehensive system test runner
      run: npm run test:system:run
      if: matrix.browser == 'chromium' && matrix.node-version == '18.x'
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: system-test-results-${{ matrix.browser }}-${{ matrix.node-version }}
        path: |
          coverage/playwright-report/
          coverage/system-reports/
          coverage/test-results.json
          
    - name: Upload Playwright traces
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-traces-${{ matrix.browser }}-${{ matrix.node-version }}
        path: coverage/playwright-artifacts/
        
  security-tests:
    runs-on: ubuntu-latest
    needs: system-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Use Node.js 18.x
      uses: actions/setup-node@v3
      with:
        node-version: 18.x
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Start services
      run: |
        npm run dev &
        sleep 10
        
    - name: Run security and accessibility tests
      run: npx playwright test tests/system/embedded-apps/security-accessibility.stest.ts
      
    - name: Upload security test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results
        path: |
          coverage/playwright-report/
          coverage/system-reports/
          
  coverage-report:
    runs-on: ubuntu-latest
    needs: [system-tests, security-tests]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Download all test results
      uses: actions/download-artifact@v3
      
    - name: Generate coverage summary
      run: |
        echo "# System Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        
        # Count test result files
        RESULT_FILES=$(find . -name "system-test-results-*" -type d | wc -l)
        echo "- Test configurations run: $RESULT_FILES" >> $GITHUB_STEP_SUMMARY
        
        # Check for security results
        if [ -d "security-test-results" ]; then
          echo "- Security tests: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Security tests: âŒ Failed or skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Applications Tested" >> $GITHUB_STEP_SUMMARY
        echo "- Log Analysis Dashboard (http://localhost:3457)" >> $GITHUB_STEP_SUMMARY
        echo "- AI Dev Portal (auto-discovery)" >> $GITHUB_STEP_SUMMARY
        echo "- Setup Configuration UI (auto-discovery)" >> $GITHUB_STEP_SUMMARY
        echo "- Monitoring Dashboards (auto-discovery)" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Categories" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Authentication Flows" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Data Input Validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Real-time Updates" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Error Handling" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Cross-browser Compatibility" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security Testing" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Accessibility Compliance" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ğŸ§ª System Test Results\n\n`;
          comment += `### Test Execution\n`;
          comment += `- **Status**: Tests completed\n`;
          comment += `- **Browsers**: Chrome, Firefox, Safari\n`;
          comment += `- **Node versions**: 18.x, 20.x\n\n`;
          
          comment += `### Applications Tested\n`;
          comment += `- âœ… Log Analysis Dashboard\n`;
          comment += `- ğŸ” AI Dev Portal (auto-discovery)\n`;
          comment += `- ğŸ” Setup Configuration UI (auto-discovery)\n`;
          comment += `- ğŸ” Monitoring Dashboards (auto-discovery)\n\n`;
          
          comment += `### Security & Accessibility\n`;
          comment += `- âœ… XSS Prevention Testing\n`;
          comment += `- âœ… CSRF Protection Validation\n`;
          comment += `- âœ… Input Sanitization\n`;
          comment += `- âœ… ARIA Compliance\n`;
          comment += `- âœ… Keyboard Navigation\n`;
          comment += `- âœ… Responsive Design\n\n`;
          
          comment += `### ğŸ“Š Detailed Reports\n`;
          comment += `Check the workflow artifacts for comprehensive HTML reports and traces.\n`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
